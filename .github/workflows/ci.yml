name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  lint:
    runs-on: ubuntu-latest
    name: Lint Helm Chart
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Helm
      uses: azure/setup-helm@v3
      with:
        version: v3.14.0

    - name: Lint Helm Chart
      run: helm lint charts/lang-observatory

    - name: Run chart-testing (lint)
      uses: helm/chart-testing-action@v2.6.1
      with:
        command: lint
        config: .github/ct.yaml

  test:
    runs-on: ubuntu-latest
    name: Test Helm Chart
    needs: lint
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Helm
      uses: azure/setup-helm@v3
      with:
        version: v3.14.0

    - name: Add Helm dependencies
      run: |
        helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
        helm repo add grafana https://grafana.github.io/helm-charts
        helm repo update

    - name: Install Helm dependencies
      run: helm dependency update charts/lang-observatory

    - name: Create kind cluster
      uses: helm/kind-action@v1.5.0

    - name: Run chart-testing (install)
      uses: helm/chart-testing-action@v2.6.1
      with:
        command: install
        config: .github/ct.yaml

  security:
    runs-on: ubuntu-latest
    name: Security Scan
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

  release:
    if: github.ref == 'refs/heads/main'
    needs: [lint, test, security]
    runs-on: ubuntu-latest
    name: Release Helm Chart
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Configure Git
      run: |
        git config user.name "$GITHUB_ACTOR"
        git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

    - name: Set up Helm
      uses: azure/setup-helm@v3
      with:
        version: v3.14.0

    - name: Add Helm dependencies
      run: |
        helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
        helm repo add grafana https://grafana.github.io/helm-charts
        helm repo update

    - name: Run chart-releaser
      uses: helm/chart-releaser-action@v1.5.0
      env:
        CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
        CR_CHARTS_REPO: "https://terragon-labs.github.io/lang-observatory"